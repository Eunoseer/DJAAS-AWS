AWSTemplateFormatVersion: '2010-09-09'
Description: Dad jokes as a service
Parameters:
  pAccountNumber:
    Type: String
    MinLength: '12'
    MaxLength: '12'
    AllowedPattern: '[0-9]*'
    Description: 'The account ID to deploy the cloudformation stack to.'
    Default: '123456789000'

  # DynamoDB
  pDynamoDBTableName:
    Type: String
    MinLength: '3'
    MaxLength: '255'
    AllowedPattern: '[a-zA-Z0-9_.-]+'
    Description: 'The name of the Dad Jokes DynamoDB Table'
    Default: Dad_Jokes
  pDynamoDBPKName:
    Type: String
    MinLength: '1'
    MaxLength: '2048'
    AllowedPattern: '[a-zA-Z0-9]*'
    Description: HashType PrimaryKey Name
    Default: Id
    ConstraintDescription: must contain only alphanumeric characters
  pDynamoDBPKType:
    Type: String
    MinLength: '1'
    MaxLength: '1'
    AllowedPattern: '[S|N]'
    Description: HashType PrimaryKey Type
    Default: S
    ConstraintDescription: must be either S or N
  pDynamoDBJokeName:
    Type: String
    MaxLength: '2048'
    Description: Name
    Default: JokeText
  pDynamoDBJokeType:
    Type: String
    Description: Type
    Default: S
  pReadCapacityUnits:
    Type: Number
    MinValue: '1'
    MaxValue: '100'
    Description: Provisioned read throughput
    Default: '1'
    ConstraintDescription: must be between 1 and 100
  pWriteCapacityUnits:
    Type: Number
    MinValue: '1'
    MaxValue: '100'
    Description: Provisioned write throughput
    Default: '1'
    ConstraintDescription: must be between 1 and 100

  # Lambda
  pLambdaExecutionRoleName:
    Type: String
    MinLength: '1'
    MaxLength: '64'
    AllowedPattern: '[\w+=,.@-]+'
    Description: The name of the lambda execution role.
    Default: Lambda-Role-DadJokes
  pLambdaExecutionPolicyName:
    Type: String
    MinLength: '1'
    MaxLength: '64'
    AllowedPattern: '[\w+=,.@-]+'
    Description: The name of the lambda execution policy.
    Default: Lambda-Policy-DadJokes
  pLambdaFunctionNameRandom:
    Type: String
    MinLength: '1'
    MaxLength: '64'
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9_-]*'
    Description: The name of the lambda function to return random results.
    Default: Lambda-DynamoDB-DadJokes-GetRandom

  # Api Gateway
  pApiGatewayRoleName:
    Type: String
    MinLength: '1'
    MaxLength: '64'
    AllowedPattern: '[\w+=,.@-]+'
    Description: The name of the API Gateway lambda execution role.
    Default: ApiGatewayLambdaCallerRole
  pApiGatewayPolicyName:
    Type: String
    MinLength: '1'
    MaxLength: '64'
    AllowedPattern: '[\w+=,.@-]+'
    Description: The name of the API Gateway lambda execution policy.
    Default: ApiGatewayLambdaCallerPolicy
  pApiGatewayName:
    Type: String
    MinLength: '1'
    MaxLength: '64'
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9_-]*'
    Description: The name of the lambda function to return random results.
    Default: DadJokes-HttpApi

Resources:
  # DynamoDB
  rDynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Ref pDynamoDBTableName
      AttributeDefinitions:
      - AttributeName: !Ref pDynamoDBPKName
        AttributeType: !Ref pDynamoDBPKType
      - AttributeName: !Ref pDynamoDBJokeName
        AttributeType: !Ref pDynamoDBJokeType
      KeySchema:
      - AttributeName: !Ref pDynamoDBPKName
        KeyType: HASH
      - AttributeName: !Ref pDynamoDBJokeName
        KeyType: RANGE
      ProvisionedThroughput:
        ReadCapacityUnits: !Ref pReadCapacityUnits
        WriteCapacityUnits: !Ref pWriteCapacityUnits

  # Lambda
  rLambdaGetRandom:
    Type: AWS::Lambda::Function
    DependsOn: rLambdaExecutionRole
    Properties:
      FunctionName: !Ref pLambdaFunctionNameRandom
      Architectures:
      - arm64
      Description: Retrieves a random dad joke from DynamoDB. Returns a JSON object.
      Role:
        !GetAtt rLambdaExecutionRole.Arn
      Runtime: nodejs18.x
      Handler: index.handler
      Code:
        ZipFile: /lambda/random.js
  rLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Ref pLambdaExecutionRoleName
      Description: The role used by Lambda to log to cloudwatch.
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
  rLambdaExecutionPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Ref pLambdaExecutionPolicyName
      Roles:
      - !Ref rLambdaExecutionRole
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - Logs:CreateLogGroup
          Resource:
          - !Sub arn:aws:logs:ap-southeast-2:${pAccountNumber}:*
        - Effect: Allow
          Action:
          - logs:CreateLogStream
          - logs:PutLogEvents
          Resource:
          - !Sub arn:aws:logs:ap-southeast-2:${pAccountNumber}:log-group:/aws/lambda/${pLambdaFunctionNameRandom}:*

  # Api Gateway
  rApiGatewayRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Ref pApiGatewayRoleName
      Description: The role used by API Gateway to handle calls to Lambda functions
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - apigateway.amazonaws.com
          Action:
          - sts:AssumeRole
  rApiGatewayPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Ref pApiGatewayPolicyName
      Roles:
      - !Ref rApiGatewayRole
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - lambda:InvokeFunction
          - lambda:InvokeAsync
          - lambda:GetFunction
          Resource:
          - !GetAtt rLambdaGetRandom.Arn
  rApiGateway:
    Type: AWS::ApiGatewayV2::Api
    DependsOn:
    - rApiGatewayRole
    Properties:
      Body:
        openapi: 3.0.1
        info:
          title: !Ref pApiGatewayName
          version: 2023-05-12 07:50:42UTC
          description: The HTTP api gateway that handles calls for the Dad Jokes API.
        paths:
          /jokes/random:
            get:
              responses:
                default:
                  description: Default response for GET /random
              x-amazon-apigateway-integration:
                payloadFormatVersion: '2.0'
                type: aws_proxy
                httpMethod: POST
                uri: !Sub arn:aws:apigateway:ap-southeast-2:lambda:path/2015-03-31/functions/arn:aws:lambda:ap-southeast-2:${pAccountNumber}:function:${pLambdaFunctionNameRandom}/invocations
                connectionType: INTERNET
        x-amazon-apigateway-importexport-version: '1.0'
  rApiGatewayStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref rApiGateway
      StageName: dev
  rApiGatewayStageDeploy:
    Type: AWS::ApiGatewayV2::Deployment
    DependsOn: rApiGatewayStage
    Properties:
      ApiId: !Ref rApiGateway
      Description: The default deployment stage for DadJokesHTTPApi.
      StageName: dev
Outputs:
  oDynamoDBTable:
    Value:
      Ref: rDynamoDBTable
    Description: Newly created Dad Jokes DynamoDB table.
